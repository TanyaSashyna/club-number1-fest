var feUrl=window.location.href,stratis=stratis||{},popupUrl="undefined"!=typeof settings?settings.stratis_map.popup:void 0!==feUrl?feUrl:window.location.origin;stratis.map=stratis.map||angular.module("map",["openlayers-directive"]);var MapController=function(i,e,n,t,s,o){i.$page=e.page,i.$dom=$(o),i.mapContainer=angular.element(".map"),i.mapContainer.length&&(i.controllerName=i.mapContainer.attr("ng-controller")),i.updateSize=function(){n.getMap().then(function(e){e.updateSize()})},i.settings={defaultMarker:"/images/map/marker.png",clusterMarker:"/images/map/map-cluster-icon.png",selectedMarker:"/images/map/selected-marker.png",defaultLat:48.8566,defaultLon:2.3522,defaultZoom:5,minZoom:0,maxZoom:18,doubleClickZoom:!1,mouseWheelZoom:!0,showZoomButtons:!0,zoomToExtent:!0,routeMarker:"/images/map/marker.png",routeColor:"#303030",BEController:"tx_news_pi1[overwriteDemand][singleNewsIds]",ADMCMDcooluri:1},i.updateSettings=function(){try{$.extend(i.settings,$.parseJSON(e.settings))}catch(e){console.error(e)}},i.updateSettings(),i.backgroundLayers=[{name:"Vue plan",css:"plan",source:{type:"OSM"}},{name:"Vue satellite",css:"satellite",source:{name:"Bing Maps",type:"BingMaps",key:"Aj6XtE1Q1rIvehmjn2Rh1LR2qvMGZ-8vPS9Hn3jCeUiToM77JFnf-kFRzyMELDol",imagerySet:"Aerial"}}];var r="background-switch";i.selectedBackLayer=i.backgroundLayers[0],i.changeBackLayer=function(){$.each(i.backgroundLayers,function(e,t){t.index=0,t.visible=!1}),i.selectedBackLayer.visible=!0,$("."+r).attr("class",r).addClass(r+"--"+i.selectedBackLayer.css)},i.changeBackLayer();var a=function(t){n.getMap().then(function(e){e.getLayers().forEach(t)})},l=function(t){a(function(e){e.get("markers")&&e.getSource().getSource().getFeatures().forEach(t)})};i.markers={},i.markers.forEach=l,i.markers.findByUid=function(t,o){l(function(e){e.get("uid")===t?(e.set("selected",!0),o(e)):e.set("selected",!1)})},i.markers.findAll=function(o){a(function(e){if(e.get("markers")){var t=e.getSource();o(t.getSource().getFeatures())}})},i.zoomToExtent=function(e,r){for(var a=ol.extent.createEmpty(),t=0,o=(e=Array.isArray(e)?e:[e]).length;t<o;t++)e[t]instanceof ol.layer.Layer&&(a=ol.extent.extend(a,e[t].getSource().getExtent())),e[t]instanceof ol.Feature&&(a=ol.extent.extend(a,e[t].getGeometry().getExtent()));n.getMap().then(function(e){r=r||200;var t=ol.animation.pan({source:e.getView().getCenter(),duration:r}),o=ol.animation.zoom({resolution:e.getView().getResolution(),duration:r});e.beforeRender(t,o),-1===a.indexOf(1/0)&&e.getView().fit(a,e.getSize())})},i.zoomOnContent=function(){i.markers.findAll(function(e){i.zoomToExtent(e)})},i.route=void 0,i.selectedLocation=void 0;i.routing={start:function(){var t=i.$dom.find(".tools__routing");i.route=void 0,t.addClass("tools__routing--active");navigator.geolocation.getCurrentPosition(function(e){i.$apply(function(){i.route={longitude:e.coords.longitude,latitude:e.coords.latitude,location:i.selectedLocation,callback:function(){t.removeClass("tools__routing--active"),a(function(e){e.get("route")&&i.zoomToExtent(e)})}}})},function(){t.removeClass("tools__routing--active")})},reset:function(){i.route=void 0,i.selectedLocation=void 0,l(function(e){e.set("selected",!1)})}},i.getQueryParams=function(o,e){var r={queryIds:[],queryType:520,queryController:i.settings.BEController},t={id:i.$page,type:r.queryType},a=Number(i.settings.ADMCMDcooluri);return a&&(t.ADMCMD_cooluri=a),e&&(t[r.queryController]="object"!=typeof e?e:(e.forEach(function(e){var t=e.get("element").attr("ng-click").match(/\d{1,}/gi);t.shift(),"FlexController"!==o&&(r.queryIds=r.queryIds.concat(t))}),r.queryIds.join(","))),t},angular.extend(i,{defaults:{controls:{zoom:i.settings.showZoomButtons},interactions:{mouseWheelZoom:i.settings.mouseWheelZoom,doubleClickZoom:i.settings.doubleClickZoom},view:{maxZoom:parseFloat(i.settings.maxZoom),minZoom:parseFloat(i.settings.minZoom)},styles:{marker:{text:{offsetY:-33,font:"20px Arial",color:"#fff"},image:{icon:{anchor:[.5,1],src:i.settings.defaultMarker}}},cluster:{image:{icon:{anchor:[.5,1],src:i.settings.clusterMarker}}},selected:{image:{icon:{anchor:[.5,1],src:i.settings.selectedMarker}}}}},center:{lon:parseFloat(i.settings.defaultLon),lat:parseFloat(i.settings.defaultLat),zoom:parseFloat(i.settings.defaultZoom)}}),n.getMap().then(function(n){n.getControls().forEach(function(e){if(e instanceof ol.control.Zoom){n.removeControl(e);var t=new ol.control.Zoom({zoomInTipLabel:"Zoomer",zoomOutTipLabel:"Dézoomer"});n.addControl(t)}}),n.on("click",function(e){var t=n.forEachFeatureAtPixel(e.pixel,function(e,t){return t.get("markers")?e:void 0});if(n.get("view").getZoom()===Number(i.settings.maxZoom)&&void 0!==t){var o=t.get("features"),r=i.mapContainer.find(".map-popup__content"),a=i.getQueryParams(i.controllerName,o);"FlexController"!==i.controllerName&&s({method:"GET",url:popupUrl,params:a}).then(function(e){r.html(e.data),i.mapContainer.addClass("-show-popup"),n.updateSize()})}}),n.on("pointermove",function(e){var t=n.forEachFeatureAtPixel(e.pixel,function(e,t){return t.get("markers")?e:void 0});n.getTarget().style.cursor=t?"pointer":""})})};function initMapHandlers(){var e=[].slice.call(document.querySelectorAll(".js-map-toggle")),s=function(e,t){e.forEach(t)},l=function(e){var t=e.getAttribute("data-alt-text"),o=e.innerText;t&&(e.innerText=t,e.setAttribute("data-alt-text",o))},o=function(e,t){var o=document.getElementById(e.getAttribute("data-target"));o||e.classList.add("-is-hidden");var r=o.getAttribute("aria-hidden"),a=[].slice.call(document.querySelectorAll('[data-target="'+o.id+'"]')),n=o.getAttribute("data-custom-related"),i={};if(null===r)return console.error('Target block should have "aria-hidden" attribute: ',o),!1;n&&(i.element=document.getElementById(n.split(",")[0]),i.class=n.split(",")[1].trim()),"map"===o.id&&"true"===r&&767<window.innerWidth&&e.click(),t?t&&"click"===t.type&&("false"===r?(o.setAttribute("aria-hidden",!0),s(a,function(e){e.classList.remove("-is-active"),l(e)}),i.element&&i.element.classList.remove(i.class)):(o.setAttribute("aria-hidden",!1),s(a,function(e){e.classList.add("-is-active"),l(e)}),i.element&&i.element.classList.add(i.class))):"false"===r?(s(a,function(e){e.classList.add("-is-active")}),i.element&&i.element.classList.add(i.class)):(s(a,function(e){e.classList.remove("-is-active"),l(e)}),i.element&&i.element.classList.remove(i.class))},r=function(){var e=document.querySelector(".map-update");e&&e.click()};e.length&&e.forEach(function(t){o(t),t.addEventListener("click",function(e){o(t,e),r()}),window.addEventListener("resize",function(e){o(t,e),r()})})}stratis.map.controller("MapController",["$scope","$attrs","olData","$timeout","$http","$element",MapController]),initMapHandlers();var DefaultController=function(a,e,t,o,n,r,i){i("MapController",{$scope:a,$attrs:e,olData:t,$timeout:o,$http:n,$element:r}),a.showPopup=function(r,e){a.$dom.addClass("-map-loading");var t=a.getQueryParams(a.controllerName,e);n({method:"GET",url:popupUrl,params:t}).then(function(e){var t=e.data,o=$(".popup-item-contacts",$(e.data));o.length&&(t=o),a.$dom.removeClass("-map-loading"),a.$dom.addClass("-show-popup").find(".map-popup__content").html(t),a.updateSize(),a.routing.reset(),a.selectedLocation=r,a.markers.findByUid(r,function(e){a.zoomToExtent(e)})})},a.hidePopup=function(){a.$dom.removeClass("-show-popup"),a.routing.reset(),a.updateSize(),o(a.zoomOnContent,100)},o(function(){a.markers.findAll(function(e){1===e.length?o(function(){e[0].get("element").triggerHandler("click")}):a.zoomOnContent()})},100),o(a.updateSize,100)};stratis.map.controller("DefaultController",["$scope","$attrs","olData","$timeout","$http","$element","$controller",DefaultController]);var FlexController=function(t,e,o,r,a,n,i){i("DefaultController",{$scope:t,$attrs:e,olData:o,$timeout:r,$http:a,$element:n}),t.showPopup=function(e){t.$dom.addClass("-show-popup"),t.updateSize(),t.routing.reset(),t.selectedLocation=e,t.markers.findByUid(e,function(e){t.zoomToExtent(e)})}};stratis.map.controller("FlexController",["$scope","$attrs","olData","$timeout","$http","$element","$controller",FlexController]);var LargeController=function(n,e,t,i,s,o,r,a){r("MapController",{$scope:n,$attrs:e,olData:t,$timeout:i,$http:s,$element:a}),n.$search=n.$dom.find(".map__search"),n.$popup=n.$dom.find(".map-popup"),n.$filters=$("body.map-page div.filters").find("form"),n.$reset=n.$filters.find('[type="reset"]'),n.markers.show=function(e){n.markers.findByUid(parseInt(e),function(e){n.zoomToExtent(e)})},n.IEPolyfill=function(){if("function"==typeof window.CustomEvent)return!1;function e(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var o=document.createEvent("CustomEvent");return o.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),o}e.prototype=window.Event.prototype,window.CustomEvent=e},n.IEPolyfill(),n.markers.reveal=function(){n.markers.forEach(function(e){e.set("hidden",!1)})},n.hasUrlIdsParams=function(){if(location.search){var e=n.sepUrlParams();return!(!e.uid&&!e.singleNewsIds)}},n.sepUrlParams=function(){var e=location.search.substring(1).split("&"),r={};return e.forEach(function(e){var t=e.split("="),o=t[0];r[o]=t[1]}),r},n.setParams=function(e,t,o,r){var a=document.querySelector(e);a&&Array.from(a.querySelectorAll(t)).forEach(function(e){o&&r?e.search="?uid="+o+"&singleNewsIds="+r:o?e.search="?uid="+o:r&&(e.search="&singleNewsIds="+r)})},n.popupAction=function(a,e){$("body").addClass("-map-loading");var t=n.getQueryParams(n.controllerName,e);s({method:"GET",url:popupUrl,params:t}).then(function(e){var t=e.data,o=$(".popup-item-contacts, .map-popup__heading",$(e.data));o.length&&(t=o),$("body").removeClass("-map-loading"),n.$dom.addClass("-show-popup"),n.$popup.find(".map-popup__content").html(t),n.updateSize(),i(n.markers.show(a),100),n.routing.selectedLocation=a;var r=new CustomEvent("openPopup");window.dispatchEvent(r)})},n.showPopup=n.popupAction,n.searchAction=function(){n.routing.reset(),n.$dom.removeClass("-show-popup"),$("body").addClass("-map-loading"),n.updateSize();for(var e=n.$filters.serializeArray(),t={},o=0,r=e.length;o<r;o++)e[o].name.indexOf("__referrer")<0&&(t[e[o].name]=e[o].value);return t.id=n.$page,t.type="json",t.ADMCMD_cooluri=1,s({method:"GET",url:popupUrl,params:t,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){$("body").removeClass("-map-loading"),n.filterMarkers($.makeArray(e.data))}),!1},n.resultAction=function(e,r){s({method:"GET",url:popupUrl,params:{id:n.$page,"tx_stratismap_map[controller]":n.originController,"tx_stratismap_map[action]":"result","tx_stratismap_map[news]":e,ADMCMD_cooluri:1,type:"blank"}}).then(function(e){var t=e.data,o=$(".popup-item-contacts, .map-popup__heading",$(e.data));o.length&&(t=o),n.$dom.addClass("-show-popup"),n.$popup.find(".map-popup__content").html(t),n.routing.reset(),n.updateSize(),n.filterMarkers(r)})},n.resetAction=function(){n.$dom.removeClass("-show-results -show-popup"),n.updateSize(),n.routing.reset(),n.markers.reveal(),i(n.zoomOnContent,100)},n.$reset.on("click",n.resetAction),n.showMenu=function(){n.$dom.toggleClass("map__menu--active")},n.hideSearch=function(){n.$dom.removeClass("-show-results -show-popup"),n.updateSize(),n.markers.reveal(),i(n.zoomOnContent,100)},n.toggleSearch=function(){n.$dom.toggleClass("-show-results"),n.$filters.find(".filters__toggle").text(function(){return n.$dom.hasClass("-show-results")?"Masquer les résultats":"Afficher les résultats"}),n.updateSize(),n.markers.reveal(),i(n.zoomOnContent,100)},n.$filters.find(".filters__toggle").click(n.toggleSearch),n.hidePopup=function(){n.$dom.removeClass("-show-popup"),n.updateSize(),n.markers.reveal(),n.routing.reset(),i(n.zoomOnContent,100)};n.filterMarkers=function(a){n.markers.forEach(function(e){var t,o,r=e.get("attributes").clustered.split(",").map(Number);e.set("hidden",!(t=a,o=r,$.map(t,function(e){return $.inArray(e,o)<0?null:e})).length)}),0<a.length?n.markers.findAll(function(e){var t=$.grep(e,function(e){return!1===e.get("hidden")});n.zoomToExtent(t)}):t.getMap().then(function(e){var t=[parseFloat(n.settings.defaultLon),parseFloat(n.settings.defaultLat)];e.getView().setCenter(ol.proj.transform(t,"EPSG:4326","EPSG:3857")),e.getView().setZoom(parseFloat(n.settings.defaultZoom))})},n.settings.zoomToExtent&&(i(n.updateSize,100),i(n.zoomOnContent,100))};stratis.map.controller("LargeController",["$scope","$attrs","olData","$timeout","$http","$compile","$controller","$element",LargeController]);var RouteDirective=function(e,t,d,m,n){return{restrict:"E",scope:{properties:"=olRouteProperties",style:"=olStyle"},require:"^openlayers",replace:!0,template:'<div class="popup-label route" ng-bind-html="message"></div>',link:function(s,e,t,o){var l=n.isDefined,u=n.createFeature,r=n.createVectorLayer,a=n.insertLayer,c=n.removeLayer,p=o.getOpenlayersScope();p.getMap().then(function(e){var n=m.getDefaults(p).view.projection,i=r();i.set("route",!0),i.index=9999;var t=e.getLayers();a(t,t.getLength(),i),s.$on("$destroy",function(){c(t,i.index)}),s.$watch("properties",function(a){if(s.feature&&(i.getSource().removeFeature(s.feature),i.getSource().removeFeature(s.departureMarker),delete s.feature,delete s.departureMarker),l(a)&&l(a.longitude)&&l(a.latitude)){d({method:"GET",url:popupUrl,params:{eID:"stratis_map_route",lon:a.longitude,lat:a.latitude,uid:a.location,ADMCMD_cooluri:1,no_cache:1}}).then(function(e){if(200==e.status&&"Ok"==e.data.code){var t=e.data.routes;if(0!=t.length){var o=(new ol.format.Polyline).readGeometry(t[0].geometry,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});s.feature=new ol.Feature({type:"route",geometry:o}),s.feature.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({width:6,color:[40,40,40,.8]})})),i.getSource().addFeature(s.feature);var r={projection:"EPSG:4326",lat:a.latitude,lon:a.longitude,style:{image:{icon:{anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",opacity:1,src:"/typo3conf/ext/stratis_site/Resources/Public/Images/map/marker-user.png"}}}};s.departureMarker=u(r,n),i.getSource().addFeature(s.departureMarker),(l(a.callback)?a.callback:$.noop())()}else console.log("[Stratis] Route: No route found!")}else console.log("[Stratis] Route: Bad response")})}})})}}};angular.module("openlayers-directive").directive("olRoute",["$log","$q","$http","olMapDefaults","olHelpers",RouteDirective]);